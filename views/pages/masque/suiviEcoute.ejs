<!DOCTYPE html>
<script>

</script>
<html lang="en">
<head>

  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta name="generator" content="Bootply" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="stylesheet" href="/styles/importer.css">
  <link rel="stylesheet" href="/bootflat/css/bootflat.min.css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="/css/local.css">
  <link rel="stylesheet" href="/css/Style_v3.css">
  <link rel="stylesheet" href="/jquery-ui/jquery-ui.css">
  <style type="text/css">
    .bs-notation_almerys{
      margin: 50px;
    }
    .table {
      width: 100%;
      margin-bottom: 20px;
    }
    .table > thead > tr > th,
    .table > tbody > tr > th,
    .table > tfoot > tr > th,
    .table > thead > tr > td,
    .table > tbody > tr > td,
    .table > tfoot > tr > td {
      padding: 8px;
      line-height: 1.42857143;
      vertical-align: top;
      border-top: 1px solid #d6d6d6;
    }
    .table > thead > tr > th {
      background-color: transparent;
      vertical-align: bottom;
      border-bottom: 2px solid #e8e8e8;
    }
    .table > caption + thead > tr:first-child > th,
    .table > colgroup + thead > tr:first-child > th,
    .table > thead:first-child > tr:first-child > th,
    .table > caption + thead > tr:first-child > td,
    .table > colgroup + thead > tr:first-child > td,
    .table > thead:first-child > tr:first-child > td {
      border-top: 0;
    }
    .table > tbody + tbody {
      border-top: 2px solid #cacaca;
    }
    .table .table {
      background-color: #060606;
    }
    .table-condensed > thead > tr > th,
    .table-condensed > tbody > tr > th,
    .table-condensed > tfoot > tr > th,
    .table-condensed > thead > tr > td,
    .table-condensed > tbody > tr > td,
    .table-condensed > tfoot > tr > td {
      padding: 5px;
    }
    .table-bordered {
      border: 1px solid #d4d4d4;
    }
    .table-bordered > thead > tr > th,
    .table-bordered > tbody > tr > th,
    .table-bordered > tfoot > tr > th,
    .table-bordered > thead > tr > td,
    .table-bordered > tbody > tr > td,
    .table-bordered > tfoot > tr > td {
      border: 1px solid #dcdcdc;
    }
    .table-bordered > thead > tr > th,
    .table-bordered > thead > tr > td {
      border-bottom-width: 2px;
    }
    .table-striped > tbody > tr:nth-child(odd) > td,
    .table-striped > tbody > tr:nth-child(odd) > th {
      background-color: #080808;
    }
    .table-hover > tbody > tr:hover > td,
    .table-hover > tbody > tr:hover > th {
      background-color: #282828;
    }
    table col[class*="col-"] {
      position: static;
      float: none;
      display: table-column;
    }
    table td[class*="col-"],
    table th[class*="col-"] {
      position: static;
      float: none;
      display: table-cell;
    }
    .table > thead > tr > td.active,
    .table > tbody > tr > td.active,
    .table > tfoot > tr > td.active,
    .table > thead > tr > th.active,
    .table > tbody > tr > th.active,
    .table > tfoot > tr > th.active,
    .table > thead > tr.active > td,
    .table > tbody > tr.active > td,
    .table > tfoot > tr.active > td,
    .table > thead > tr.active > th,
    .table > tbody > tr.active > th,
    .table > tfoot > tr.active > th {
      background-color: #282828;
    }
    .table-hover > tbody > tr > td.active:hover,
    .table-hover > tbody > tr > th.active:hover,
    .table-hover > tbody > tr.active:hover > td,
    .table-hover > tbody > tr.active:hover > th {
      background-color: #1b1b1b;
    }
    .table > thead > tr > td.success,
    .table > tbody > tr > td.success,
    .table > tfoot > tr > td.success,
    .table > thead > tr > th.success,
    .table > tbody > tr > th.success,
    .table > tfoot > tr > th.success,
    .table > thead > tr.success > td,
    .table > tbody > tr.success > td,
    .table > tfoot > tr.success > td,
    .table > thead > tr.success > th,
    .table > tbody > tr.success > th,
    .table > tfoot > tr.success > th {
      background-color: #77b300;
    }
    .table-hover > tbody > tr > td.success:hover,
    .table-hover > tbody > tr > th.success:hover,
    .table-hover > tbody > tr.success:hover > td,
    .table-hover > tbody > tr.success:hover > th {
      background-color: #669a00;
    }
    .table > thead > tr > td.info,
    .table > tbody > tr > td.info,
    .table > tfoot > tr > td.info,
    .table > thead > tr > th.info,
    .table > tbody > tr > th.info,
    .table > tfoot > tr > th.info,
    .table > thead > tr.info > td,
    .table > tbody > tr.info > td,
    .table > tfoot > tr.info > td,
    .table > thead > tr.info > th,
    .table > tbody > tr.info > th,
    .table > tfoot > tr.info > th {
      background-color: #9933cc;
    }
    .table-hover > tbody > tr > td.info:hover,
    .table-hover > tbody > tr > th.info:hover,
    .table-hover > tbody > tr.info:hover > td,
    .table-hover > tbody > tr.info:hover > th {
      background-color: #8a2eb8;
    }
    .table > thead > tr > td.warning,
    .table > tbody > tr > td.warning,
    .table > tfoot > tr > td.warning,
    .table > thead > tr > th.warning,
    .table > tbody > tr > th.warning,
    .table > tfoot > tr > th.warning,
    .table > thead > tr.warning > td,
    .table > tbody > tr.warning > td,
    .table > tfoot > tr.warning > td,
    .table > thead > tr.warning > th,
    .table > tbody > tr.warning > th,
    .table > tfoot > tr.warning > th {
      background-color: #ff8800;
    }
    .table-hover > tbody > tr > td.warning:hover,
    .table-hover > tbody > tr > th.warning:hover,
    .table-hover > tbody > tr.warning:hover > td,
    .table-hover > tbody > tr.warning:hover > th {
      background-color: #e67a00;
    }
    .table > thead > tr > td.danger,
    .table > tbody > tr > td.danger,
    .table > tfoot > tr > td.danger,
    .table > thead > tr > th.danger,
    .table > tbody > tr > th.danger,
    .table > tfoot > tr > th.danger,
    .table > thead > tr.danger > td,
    .table > tbody > tr.danger > td,
    .table > tfoot > tr.danger > td,
    .table > thead > tr.danger > th,
    .table > tbody > tr.danger > th,
    .table > tfoot > tr.danger > th {
      background-color: #cc0000;
    }
    .table-hover > tbody > tr > td.danger:hover,
    .table-hover > tbody > tr > th.danger:hover,
    .table-hover > tbody > tr.danger:hover > td,
    .table-hover > tbody > tr.danger:hover > th {
      background-color: #b30000;
    }
    @media (max-width: 767px) {
      .table-responsive {
        width: 100%;
        margin-bottom: 15px;
        overflow-y: hidden;
        overflow-x: scroll;
        -ms-overflow-style: -ms-autohiding-scrollbar;
        border: 1px solid #282828;
        -webkit-overflow-scrolling: touch;
      }
      .table-responsive > .table {
        margin-bottom: 0;
      }
      .table-responsive > .table > thead > tr > th,
      .table-responsive > .table > tbody > tr > th,
      .table-responsive > .table > tfoot > tr > th,
      .table-responsive > .table > thead > tr > td,
      .table-responsive > .table > tbody > tr > td,
      .table-responsive > .table > tfoot > tr > td {
        white-space: nowrap;
      }
      .table-responsive > .table-bordered {
        border: 0;
      }
      .table-responsive > .table-bordered > thead > tr > th:first-child,
      .table-responsive > .table-bordered > tbody > tr > th:first-child,
      .table-responsive > .table-bordered > tfoot > tr > th:first-child,
      .table-responsive > .table-bordered > thead > tr > td:first-child,
      .table-responsive > .table-bordered > tbody > tr > td:first-child,
      .table-responsive > .table-bordered > tfoot > tr > td:first-child {
        border-left: 0;
      }
      .table-responsive > .table-bordered > thead > tr > th:last-child,
      .table-responsive > .table-bordered > tbody > tr > th:last-child,
      .table-responsive > .table-bordered > tfoot > tr > th:last-child,
      .table-responsive > .table-bordered > thead > tr > td:last-child,
      .table-responsive > .table-bordered > tbody > tr > td:last-child,
      .table-responsive > .table-bordered > tfoot > tr > td:last-child {
        border-right: 0;
      }
      .table-responsive > .table-bordered > tbody > tr:last-child > th,
      .table-responsive > .table-bordered > tfoot > tr:last-child > th,
      .table-responsive > .table-bordered > tbody > tr:last-child > td,
      .table-responsive > .table-bordered > tfoot > tr:last-child > td {
        border-bottom: 0;
      }
    }



    div.scrollmenu {
      background-color: #333;
      overflow: auto;
      white-space: nowrap;
    }

    div.scrollmenu a {
      display: inline-block;
      color: white;
      text-align: center;
      padding: 14px;
      text-decoration: none;
    }

    div.scrollmenu a:hover {
      background-color: #777;
    }
  </style>
  <title>Suivi écoute</title>
</head>
<body onload="loadCE('u');"> <!-- loadTemplate(); showTableB(); -->
<% if(req.session.droit==1){

%>
<% include ../../includes/entete.ejs %>
<% }else{

%>
<% include ../../includes/enteteOperateur.ejs %>

<% }%>
<!-- /HEADER -->

<!-- Main -->
<div id="page-wrapper">
    <div class="row">

	<div class="page-title" style="margin-left:25px">
	  <div class="title_left">
		<h3 style="color:#2B75A6;">
		  Suivi Ecoute
		</h3>
	  </div>
	</div></br>

		<!-- FROM FR -->
	<div class="form-group col-md-10">
		  <div class="form-group col-md-2">
			<label for="ce_select">CQ</label>
			<select class="form-control" id="ce_select" > <!-- onchange="loadTC(this.value,0)" loadVague(this.value); -->
			  <option value="">-</option>
			</select>
		  </div>
		  <div class="form-group col-md-2">
			<label for="date_input">Date debut</label>
			<input class="form-control" id="date_input" type="text"/>
		  </div>
		  <div class="form-group col-md-2">
			<label for="date_input2">Date fin</label>
			<input class="form-control" id="date_input2" type="text"/>
		  </div>

		  <div class='form-group col-md-2' >
		  <label for="tc_select">.</label>
				<a class="form-control btn btn-primary" href="#" role="button" onclick = "getSuiviTab()">OK</a>
		  </div>
		</div>

		</br>
		</br>
		<div class="col-md-12">
		  <table class="table" id="table-globale">
			<thead>
			  <tr>
				<th>CQ</th>
				<th>Dates</th>
				<th>Nombre d'écoutes</th>
				<th>Temps d'écoutes</th>
				<th>Temps de présence</th>
				<th>Taux d'occupation</th>
				<th>Moyenne taux d'occupation</th>
				<th>Moyenne temps d'écoute</th>
				<th>Somme durée d'appel</th>
				<!--<th>Objectif durée d'écoute</th>
				<th>Ecart par rapport à l'objectif</th>-->
				<th>Vitesse d'écoute</th>
				<th>Moyenne / CQ</th>
				<th>Commentaires</th>

				<th><i class='fa fa-edit'></i></th>
				<th><i class='fa fa-line-chart'></i></th>

				<!--<th>Reprise</th>-->
			  </tr>
			</thead>
			<tbody id="glob_cr">
			  <tr>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<!--<td></td>
				<td></td>-->

				<td></td>
				<td></td>
			  </tr>
			</tbody>
		  </table>
		  <br/>
		  <br/>
		  <div id='echart_line_glob2' class="hidden" style='height:600px;'></div>

		</div>

	</div>
	<!-- FIN FR -->

    </div>
  </div>



<!-- Modal courbe -->
<div class="modal fade" id="modalCourbe" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <!--Content-->
    <form method="GET" action="#" >
      <div class="modal-content">
        <!--Header-->
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
          <h4 class="modal-title" id="myModalLabel">Evolution Ecoute</h4>
        </div>
        <!--Body-->
        <div class="modal-body">
          <div class="row">
            <div id='echart_line_glob' style='height:600px;'></div>
          </div>
        </div>
        <!--Footer-->
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">FermÃ©</button>
        </div>
      </div>
    </form>
    <!--/.Content-->
  </div>
</div>
<!--Fin Modal courbe -->

</body>
<script src="/js/vendors/echarts.min.js"></script>
<script src="/js/jquery-1.12.4.js"></script>
<script src="/js/dependencies/sails.io.js"></script>
<script src="/js/jquery-ui.min.js"></script>
<script src="/js/echarts/theme.js"></script>
<script src="/js/echarts/echarts.js"></script>

<script src="/bootstrap/js/bootstrap.min.js"></script>
<script src="/js/bootbox.min.js"></script>
<script src="/vendors/fastclick/lib/fastclick.js"></script>
<!-- Custom Theme Scripts -->
<script src="/vendors/datatables.net/js/jquery.dataTables.min.js"></script>
<script src="/vendors/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
<script src="/vendors/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
<script src="/vendors/datatables.net-buttons-bs/js/buttons.bootstrap.min.js"></script>
<script src="/vendors/datatables.net-buttons/js/buttons.flash.min.js"></script>
<script src="/vendors/datatables.net-buttons/js/buttons.html5.min.js"></script>
<script src="/vendors/datatables.net-buttons/js/buttons.print.min.js"></script>
<script src="/vendors/datatables.net-fixedheader/js/dataTables.fixedHeader.min.js"></script>
<script src="/vendors/datatables.net-keytable/js/dataTables.keyTable.min.js"></script>
<script src="/vendors/datatables.net-responsive/js/dataTables.responsive.min.js"></script>
<script src="/vendors/datatables.net-responsive-bs/js/responsive.bootstrap.js"></script>
<script src="/vendors/datatables.net-scroller/js/datatables.scroller.min.js"></script>
<script src="/vendors/jszip/dist/jszip.min.js"></script>
<script src="/vendors/pdfmake/build/pdfmake.min.js"></script>
<script src="/vendors/pdfmake/build/vfs_fonts.js"></script>
<script src="/js/custom.min.js"></script>
<!--script customise-->

<script language="javascript">
function loadDataTableG() {
    //datatable-buttons_det
		var handleDataTableButtons_gl = function() {
		  if ($("#table-globale").length) {
			$("#table-globale").DataTable({
			  dom: "Bfrtip",
			  destroy: true,
			  searching: false,
			  paging: false,
			  sort: false,
        "columnDefs": [
          { "type": "percent", "targets": 5 }
        ],
        "columns": [
          null,
          null,
          null,
          null,
          null,
          { "type": "percent" },
          null,
          null,
          null,
          null,
          null,
          null,
          null,
          null
        ],
			  "aLengthMenu": [[25, 50, 75, -1], [25, 50, 75, "All"]],
			  "iDisplayLength": 25,
			  buttons: [
				{
				  extend: "copy",
				  className: "btn-sm"
				},
				{
				  extend: "csv",
				  className: "btn-sm"
				},
				{
				  extend: "excel",
				  className: "btn-sm"
				},
				{
				  extend: "pdfHtml5",
				  className: "btn-sm"
				},
				{
				  extend: "print",
				  className: "btn-sm"
				},
			  ],
			  responsive: true
			});
		  }
		};

		TableManageButtons_gl= function() {
		  "use strict";
		  return {
			init: function() {
			  handleDataTableButtons_gl();
			}
		  };
		}();
		TableManageButtons_gl.init();
	  }

	  function seconds_to_hours (seconds){
		var sec_num = parseInt(seconds, 10);
		var hours   = Math.floor(sec_num / 3600);
		var minutes = Math.floor((sec_num - (hours * 3600)) / 60);
		var seconds = sec_num - (hours * 3600) - (minutes * 60);

		if (hours   < 10) {hours   = "0"+hours;}
		if (minutes < 10) {minutes = "0"+minutes;}
		if (seconds < 10) {seconds = "0"+seconds;}
		var res =  hours+":"+minutes+":"+seconds;

		if(isNaN(hours)){
			return "00:00:00";
		}
		return res;
	  }

	   function getSuiviTab() {
			$("#table-globale").dataTable().fnDestroy()

			var date_suivi = $("#date_input").val();
			var date_suivi2 = $("#date_input2").val();
			var cq_suivi = $("#ce_select").val();

			if( $("#ce_select").val() == "u"){
				cq_suivi = "";
			}
			//alert(date_suivi + " "+ cq_suivi);

			$("#glob_cr").html("");
			//$("#table-globale").dataTable().fnDestroy()

			$.ajax({
			  type: "GET",
			  url: "/getSuiviEcoute?dateSuivi="+date_suivi+"&cqSuivi="+cq_suivi+"&dateSuivi2="+date_suivi2,

			  success: function(msg){

				var data = JSON.parse(msg);
				console.log(data);
				var htmll = "";

				var idCQ = data[0].id_pers_ecoute;
				var moyenneCQ = 0;
				var somme_taux = 0;
				var somme_vitesse = 0;
				var nombreLigne = 0;
				for (var i = 0 ; i<data.length ; i++){
					//alert(data[i].count);
					var dateS = new Date(Number(Date.parse(data[i].deb_ecoute)));

					var mois = dateS.getMonth()+1;
					if(mois < 10){
						var temp = dateS.getMonth() + 1;
						mois = "0"+temp;
					}

					var jour = dateS.getDate();
					if(jour < 10){
						var temp = dateS.getDate();
						jour = "0"+temp;
					}

					var pourcentage = (data[i].count * 100)/50;

					var purcentageE = pourcentage +" %";


					/*
					<th>Temps d'écoutes</th> somme_date_ecoute
					<th>Temps de présence</th> temps_presence
					<th>Taux d'occupation</th>
					<th>Moyenne taux d'occupation</th>
					<th>Moyenne temps d'écoute</th>
					<th>Somme durée d'appel</th>  somme_duree_appel
					<th>Objectif durée d'écoute</th>
					<th>Ecart par rapport à l'objectif</th>
					<th>Vitesse d'écoute</th>
					<th>Moyenne / CQ</th>

					Taux d’occupation (%) = temps d’écoute/ temps de présence dont
					. Temps d’écoute = somme durée d’écoute dans la statistique


					Vitesse d’écoute = temps d’écoute/temps d’appel écouté dont
					. Temps d’écoute = somme durée d’écoute dans la statistique
					. Temps d’appel écouté = somme durée d’appel dans la statistique

					*/

					var temps_presence = 28800; // "08:00:00"
					if(data[i].id_pers_ecoute == 974){
						temps_presence = 27000; //"07:00:00"
					}

					var taux_occupation = (data[i].somme_date_ecoute / temps_presence)*100;

					var vitesse_ecoute = (data[i].somme_date_ecoute / data[i].somme_duree_appel);
					if(isNaN((data[i].somme_date_ecoute / data[i].somme_duree_appel))){
						vitesse_ecoute = 1;
					}

					//var objectif_duree_ecoute = ;
					//var ecart = data[i].somme_date_ecoute -  objectif_duree_ecoute;

					//Moyenne par CQ = Somme (temps d'écoute)/somme (somme durée d'appel)

					var moyenne_cq = data[i].somme_date_ecoute / data[i].somme_duree_appel;
					if(idCQ == data[i].id_pers_ecoute){
						somme_vitesse = somme_vitesse + vitesse_ecoute;
						somme_taux = somme_taux + taux_occupation;
						nombreLigne ++;
					}else{
						idCQ = data[i].id_pers_ecoute;
						somme_vitesse = vitesse_ecoute;
						somme_taux = taux_occupation;
						nombreLigne = 1;
					}


					var moyenne_taux = 0;
					var moyenne_cq = 0;
					if(somme_taux !== 0){
						moyenne_taux = somme_taux / nombreLigne;
						moyenne_cq = somme_vitesse / nombreLigne;
					}

					var afficher_moyenne_taux = "";
					var afficher_moyenne_cq = "";

					var ii = i+1;

					if(ii !== data.length){
						if(data[i].id_pers_ecoute == data[ii].id_pers_ecoute){
							afficher_moyenne_taux = "  ";
							afficher_moyenne_cq = "  ";
						}
						else{
							afficher_moyenne_taux = moyenne_taux.toFixed(1) + "%";
							afficher_moyenne_cq = moyenne_cq.toFixed(2);
						}
					}else{
						afficher_moyenne_taux = moyenne_taux.toFixed(1) + "%";
						afficher_moyenne_cq = moyenne_cq.toFixed(2);
					}

					var dateString = dateS.getFullYear() +"-"+ mois +"-"+ jour;
					var dateNumber = dateS.getFullYear() +""+ mois +""+ jour;
					htmll += "<tr>" +
					"<td class='td_ec'>"+(data[i].appelation || '-')+"</td>"+
					"<td class='td_ec'>"+(dateString || '-')+"</td>"+
					"<td class='td_ec'>"+(data[i].count|| '-')+"</td>"+
					"<td class='td_ec'>"+(seconds_to_hours(data[i].somme_date_ecoute) || "-")+"</td>"+
					"<td class='td_ec'>"+(seconds_to_hours(temps_presence) || "-")+"</td>"+
					"<td class='td_ec'>"+taux_occupation.toFixed(1).replace('.',',')+"%</td>"+
					"<td class='td_ec'>"+afficher_moyenne_taux.replace('.',',')+"</td>"+
					"<td class='td_ec'>"+(seconds_to_hours(parseInt(data[i].moyenne_temps_ecoute)) || "-")+"</td>"+
					"<td class='td_ec'>"+(seconds_to_hours(data[i].somme_duree_appel) || "-")+"</td>"+
					/*"<td class='td_ec'>-</td>"+
					"<td class='td_ec'>-</td>"+*/
					"<td class='td_ec'>"+vitesse_ecoute.toFixed(2)+"</td>"+
					"<td class='td_ec'>"+afficher_moyenne_cq+"</td>"+
					"<td class='td_ec'>"+(unescape(data[i].commentaire_suivi_ecoute|| '-'))+"</td>"+

					"<td class='td_ec'><a href='#' onclick='modifierCommentaire("+data[i].id_pers_ecoute+", "+dateNumber+")'><i class='fa fa-edit'></i></a></td>"+
					"<td class='st st_"+i+"'><a href='#' onclick='loadDataModal("+data[i].id_pers_ecoute+")'><i class='fa fa-line-chart' ></i></a></td></tr>"; //"<td class='td_ec'>-</td>";*/

					$("#glob_cr").html(htmll);
				}
				loadDataTableG();
			  },
			  error: function (error) {

			  }
			});
		}

		function modifierCommentaire(id_pers_ecoute, date_suivi) {
			var msg ='<textarea class="form-control" id="commentaire" type="text" name="commentaire" placeholder="Commentaire ... " onchange="" required ></textarea>';

			var titre = "Ajout commentaire :";

			//alert(id_pers_ecoute + " " + date_suivi);
			var id = '<%=req.session.user %>';


			if(id == 830 || id == 832 || id == 1019){
				bootbox.dialog({
					message: msg,
					title: titre,
					buttons: {
						annuler: {
						  label: "Annuler",
						  className: "btn-default",
						  callback: function () {
							//alert("not ok");
						  }
					   },
					   main: {
						  label: "Valider",
						  className: "btn-primary",
						  callback: function () {
							var commentaire = escape($( "#commentaire" ).val());


							var year = date_suivi.toString().substring(0, 4);
							var month = date_suivi.toString().substring(4, 6);
							var day = date_suivi.toString().substring(6, 8);

							var dateSuivi = year + '-' + month + '-' + day;

							//alert(commentaire);

							window.location = encodeURI("modifierCommentaireSuivi?id_pers_ecoute="+id_pers_ecoute+"&commentaire_suivi="+commentaire+"&date_suivi="+dateSuivi);
						  }
					   }
					}
				});
			}
			else{
				bootbox.alert("Vous n'avez pas le droit d'ajouter des commentaires");
			}
		}

		function loadDataModal(cq_suivi){
			//alert(cq_suivi);

			var date_suivi = $("#date_input").val();
			var date_suivi2 = $("#date_input2").val();

			$.ajax({
			  type: "GET",
			  url: "/getSuiviEcouteSemaine?dateSuivi="+date_suivi+"&cqSuivi="+cq_suivi+"&dateSuivi2="+date_suivi2,

			  success: function(msg){
				var data = JSON.parse(msg);
				console.log(data);
				var htmll = "";

				var dateList = [];
				var nombreList = [];

				for (var i = 0 ; i<data.length ; i++){
					var dateS = new Date(Number(Date.parse(data[i].deb_ecoute)));
					var mois = dateS.getMonth()+1;
					if(mois < 10){
						var temp = dateS.getMonth() + 1;
						mois = "0"+temp;
					}
					var jour = dateS.getDate();
					if(jour < 10){
						var temp = dateS.getDate();
						jour = "0"+temp;
					}
					var dateString = jour +"-"+ mois +"-"+ dateS.getFullYear();

					nombreList.push(data[i].count);
					dateList.push(dateString+"");
				}

				//alert(dateList + " " +nombreList);

				$("#echart_line_glob2").removeClass("hidden");
				var echartLineCourbe = echarts.init(document.getElementById('echart_line_glob2'), theme);
				echartLineCourbe.setOption(getOptionLine(dateList, nombreList));

			  },
			  error: function (error) {

			  }
			});

			/*var data = datalist[index].lecoute;
			var legende = [];
			var data_courbe = [];
			$(".st").removeClass("btn-info");
			$(".st_"+index).addClass("btn-info");
			for(var i = 0;i<data.length;i++){
			  legende.push("Ecoute "+(i+1));
			  data_courbe.push(Number(data[i].note));
			}*/


		}

	  /*
	  Liste des chef d'equipe
	  */
	  function loadCE(data){
		if(data == "u") data = "";
		$.ajax({
		  type: "GET",
		  url: "/getLSSQ?sql="+data,

		  success: function(msg){
			var html = "<option value='u'> - </option>";
			var data = JSON.parse(msg);

			for (var i = 0 ; i<data.length ; i++){  //1007,974,745,766,748
				if(data[i].matricule == 745 || data[i].matricule == 974 || data[i].matricule == 1007 || data[i].matricule == 766 || data[i].matricule == 748){
					html += "<option value='"+data[i].matricule+"'>"+data[i].appelation+"</option>";
				}
			}
			$("#ce_select").html(html);
		  },
		  error: function (error) {

		  }
		});
	  }

	    $(function() {
			$( "#fin_input").datepicker({
			  dateFormat: 'yymmdd'
			}).datepicker("setDate", new Date());
			$( "#deb_input").datepicker({
			  dateFormat: 'yymmdd'
			}).datepicker("setDate", new Date());
			$( "#date_input").datepicker({
			  dateFormat: 'yy-mm-dd'
			}).datepicker("setDate", new Date());
			$( "#date_input2").datepicker({
			  dateFormat: 'yy-mm-dd'
			}).datepicker("setDate", new Date());

		  } );

		  $( window ).resize(function() {
			var window_height = $(window).height(),
			  content_height = window_height - 200;
			$('.mygrid-wrapper-div').height(content_height);
		  });

		  var id_ec = "<%=id_ecoute %>";

		  function pad(num) {
			return ("0"+num).slice(-2);
		  }
		  function hhmmss(secs) {
			var minutes = Math.floor(secs / 60);
			secs = secs%60;
			var hours = Math.floor(minutes/60)
			minutes = minutes%60;
			return pad(hours)+":"+pad(minutes)+":"+pad(secs);
		  }
</script>



<script language="javascript">
  /*
  * Fonction pour l'affichage des statistique
  * parametre
  * id_pers,date_deb,date_fin
  * */

  var datalist = [];



  function reformatDate (date_to_format) {
    var dtc = date_to_format.split('-');

    if(date_to_format!==''){
      return (dtc[2]+'/'+dtc[1]+'/'+dtc[0]);
    }else {
      return date_to_format;
    }

  }



  /*
  * showTable
  * */
  function loadDataTable() {
    //datatable-buttons_det
    var handleDataTableButtons_det = function() {
      if ($("#datatable-buttons_det").length) {
        $("#datatable-buttons_det").DataTable({
          dom: "Bfrtip",
          destroy: true,
          searching: false,
          paging: false,
          sort: false,
          "aLengthMenu": [[25, 50, 75, -1], [25, 50, 75, "All"]],
          "iDisplayLength": 25,
          buttons: [
            {
              extend: "copy",
              className: "btn-sm"
            },
            {
              extend: "csv",
              className: "btn-sm"
            },
            {
              extend: "excel",
              className: "btn-sm"
            },
            {
              extend: "pdfHtml5",
              className: "btn-sm"
            },
            {
              extend: "print",
              className: "btn-sm"
            },
          ],
          responsive: true
        });
      }
    };

    TableManageButtons_det = function() {
      "use strict";
      return {
        init: function() {
          handleDataTableButtons_det();
        }
      };
    }();
    TableManageButtons_det.init();

    var handleDataTableButtons_g = function() {
      if ($("#datatable-buttons_g").length) {
        $("#datatable-buttons_g").DataTable({
          dom: "Bfrtip",
          destroy: true,
          searching: false,
          paging: false,
          sort: false,
          "aLengthMenu": [[25, 50, 75, -1], [25, 50, 75, "All"]],
          "iDisplayLength": 25,
          buttons: [
            {
              extend: "copy",
              className: "btn-sm"
            },
            {
              extend: "csv",
              className: "btn-sm"
            },
            {
              extend: "excel",
              className: "btn-sm"
            },
            {
              extend: "pdfHtml5",
              className: "btn-sm"
            },
            {
              extend: "print",
              className: "btn-sm"
            },
          ],
          responsive: true
        });
      }
    };

    TableManageButtons_g = function() {
      "use strict";
      return {
        init: function() {
          handleDataTableButtons_g();
        }
      };
    }();
    TableManageButtons_g.init();
  }

  function loadDataTableG() {
    //datatable-buttons_det


    var handleDataTableButtons_gl = function() {
      if ($("#table-globale").length) {
        $("#table-globale").DataTable({
          dom: "Bfrtip",
          destroy: true,
          searching: false,
          paging: false,
          sort: false,
          "columnDefs": [
            { "type": "percent", "targets": 5 }
          ],
          "columns": [
            null,
            null,
            null,
            null,
            null,
            { "type": "percent" },
            null,
            null,
            null,
            null,
            null,
            null,
            null,
            null
          ],
          "aLengthMenu": [[25, 50, 75, -1], [25, 50, 75, "All"]],
          "iDisplayLength": 25,
          buttons: [
            {
              extend: "copy",
              className: "btn-sm"
            },
            {
              extend: "csv",
              className: "btn-sm"
            },
            {
              extend: "excel",
              className: "btn-sm"
            },
            {
              extend: "pdfHtml5",
              className: "btn-sm"
            },
            {
              extend: "print",
              className: "btn-sm"
            },
          ],
          responsive: true
        });
      }
    };

    TableManageButtons_gl= function() {
      "use strict";
      return {
        init: function() {
          handleDataTableButtons_gl();
        }
      };
    }();
    TableManageButtons_gl.init();
  }

  function loadDataTableG2() {
    //datatable-buttons_det


    var handleDataTableButtons_gl2 = function() {
      if ($("#table-globale-2").length) {
        $("#table-globale-2").DataTable({
          dom: "Bfrtip",
          destroy: true,
          searching: false,
          paging: false,
          sort: false,
          "aLengthMenu": [[25, 50, 75, -1], [25, 50, 75, "All"]],
          "iDisplayLength": 25,
          buttons: [
            {
              extend: "copy",
              className: "btn-sm"
            },
            {
              extend: "csv",
              className: "btn-sm"
            },
            {
              extend: "excel",
              className: "btn-sm"
            },
            {
              extend: "pdfHtml5",
              className: "btn-sm"
            },
            {
              extend: "print",
              className: "btn-sm"
            },
          ],
          responsive: true
        });
      }
    };

    TableManageButtons_gl2= function() {
      "use strict";
      return {
        init: function() {
          handleDataTableButtons_gl2();
        }
      };
    }();
    TableManageButtons_gl2.init();
  }


  function showTableDet(id,isConforme) {
    //loadTemplate();




    var html = "";
    $.ajax({
      type: "GET",
      url: "/getDataNotation?id="+id,

      success: function(msg){
        var data = JSON.parse(msg);
        var latID = null;

        for (var i = 0 ; i<list.length ; i++){
          $("#pnd_"+list[i].id_details_notation+"_det").html(""+list[i].ponderation);
          $("#na_"+list[i].id_details_notation+"_det").html("");
          $("#m_"+list[i].id_details_notation+"_det").html("");
          $("#nm_"+list[i].id_details_notation+"_det").html("");
          $("#n_"+list[i].id_details_notation+"_det").html("");
          $("#com_"+list[i].id_details_notation+"_det").html("");

        }
        for (var i = 0 ; i<data.length ; i++){
          var id_td = "";
          var nt = 0;
          ////console.log(data[i].note);
          if(data[i].note!=null){

            if(parseInt(data[i].note)==0){
              id_td = "nm_"+data[i].id_details_notation+"_det";
            }else{
              nt = Number(data[i].note);
              id_td = "m_"+data[i].id_details_notation+"_det";
            }
            $("#"+id_td).html(""+nt);
            $("#n_"+data[i].id_details_notation+"_det").html(""+nt)
          }else{
            $("#na_"+data[i].id_details_notation+"_det").html("");
            $("#n_"+data[i].id_details_notation+"_det").html("")
            $("#pnd_"+data[i].id_details_notation+"_det").html("")
          }



          $("#com_"+data[i].id_details_notation+"_det").html("<p>"+(data[i].commentaire ||'')+"</p>");

          ;
        }
        var tot_p = 0;
        var tot_n = 0;
        for (var i = 0 ; i<list.length ; i++){
          if($("#n_"+list[i].id_details_notation+"_det").text()== null || $("#n_"+list[i].id_details_notation+"_det").text()==''){
            $("#pnd_"+list[i].id_details_notation+"_det").html("");
          }else{
            tot_p += Number($("#pnd_"+list[i].id_details_notation+"_det").text());
            tot_n += Number($("#n_"+list[i].id_details_notation+"_det").text());
          }

        }
        $("#pnd_t"+"_det").html("<h3 style='color: green'>"+tot_p+"</h3>");
        $("#n_t"+"_det").html("<h3 style='color: green'>"+tot_n+"</h3>");
        var moy = (Number(tot_n)*20)/Number(tot_p);
        var com  = "";

        if(moy<15){
          com = "Conforme";
        }
        $("#n_t_v"+"_det").html("<h3 style='color: green'>"+Number(moy.toFixed(2))+"</h3>");
        //$("#com_f"+"_det").html(""+com);
        $("#com_f_det").html("Conforme");
        if(isConforme!=null){
          if(isConforme){
            $("#com_f_det").html("Conforme");
          }else{
            $("#com_f_det").html("Non conforme");
          }
        }
        loadDataTable();
      },
      error: function (error) {

      }
    });
    $("#panel_stat_det").removeClass("hidden");
    $("#panel_stat_glob").addClass("hidden");
  }

  function back_detail(){
    $("#panel_stat_det").addClass("hidden");
    $("#panel_stat_glob").removeClass("hidden");
  }




 var list = [];



</script>
<!--fin script customise-->
</html>
